<!DOCTYPE html>
<html lang="#{!empty request.remoteUser ? user.locale.language : request.locale.language}"
	xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:cc="http://xmlns.jcp.org/jsf/composite" xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
	xmlns:fn="http://xmlns.jcp.org/jsp/jstl/functions" xmlns:p="http://primefaces.org/ui"
	xmlns:pe="http://primefaces.org/ui/extensions" xmlns:o="http://omnifaces.org/ui"
	xmlns:of="http://omnifaces.org/functions" xmlns:pt="http://xmlns.jcp.org/jsf/passthrough">

<f:metadata>
	<ui:param name="bean" value="#{dataController}" />
	<o:enableRestorableView />
</f:metadata>

<f:view locale="#{request.locale}" contentType="text/html" encoding="UTF-8">
	<h:head>
		<meta http-equiv="X-UA-Compatible" content1="IE=Edge,chrome=1" />
		<title>COVID-19</title>
		<link rel="shortcut icon" type="image/x-icon" href="#{resource['favicon.ico']}" />
	</h:head>

	<h:body>
		<h:outputScript library="omnifaces" name="fixviewstate.js" target="head" />
		<h:outputStylesheet name="app.css" />
		<h:outputScript name="app.js" />

		<o:importConstants type="it.mmariotti.covid19.model.RecordProperty" var="RecordProperty" />

		<p:tabView id="tabs" dynamic="true" styleClass="app-tabs-main">
			<p:tab title="#{bundle.rankings}">
				<div style="display: flex; justify-content: space-evenly;">
					<p:panel header="#{bundle.lethality}">
						<div style="display: flex; justify-content: space-evenly;">
							<p:dataTable var="x" value="#{rankingController.lethality.target}" tableStyleClass="app-table-auto">
								<p:column>#{x.region.name}</p:column>
								<p:column>#{of:formatNumber(x.lethality, '0.00%')}</p:column>
							</p:dataTable>
							<p:dataTable var="x" value="#{rankingController.lethality.source}" tableStyleClass="app-table-auto">
								<p:column>#{x.region.name}</p:column>
								<p:column>#{of:formatNumber(x.lethality, '0.00%')}</p:column>
							</p:dataTable>
						</div>
					</p:panel>
					<p:panel header="#{bundle.growth}">
						<div style="display: flex; justify-content: space-evenly;">
							<p:dataTable var="x" value="#{rankingController.growth.target}" tableStyleClass="app-table-auto">
								<p:column>#{x.region.name}</p:column>
								<p:column>#{of:formatNumberDefault(x.growth)}</p:column>
							</p:dataTable>
							<p:dataTable var="x" value="#{rankingController.growth.source}" tableStyleClass="app-table-auto">
								<p:column>#{x.region.name}</p:column>
								<p:column>#{of:formatNumberDefault(x.growth)}</p:column>
							</p:dataTable>
						</div>
					</p:panel>
				</div>

				<h:form>
					<p:tabMenu activeIndex="#{rankingController.property.ordinal()}">
						<c:forEach var="p" items="#{RecordProperty.values()}">
							<p:menuitem action="#{rankingController.buildCustomModels}" process="@this" update="@form"
								value="#{bundle[p.name()]}">
								<f:setPropertyActionListener value="#{p}" target="#{rankingController.property}" />
							</p:menuitem>
						</c:forEach>
					</p:tabMenu>


					<div style="display: flex; justify-content: space-evenly;">
						<p:panel header="#{bundle[rankingController.property.name()]}">
							<div>
								<p:dataTable var="x" value="#{rankingController.value.target}" tableStyleClass="app-table-auto">
									<p:column>#{x.region.name}</p:column>
									<p:column>#{of:formatNumberDefault(x[rankingController.property.name()])}</p:column>
								</p:dataTable>
								<p:dataTable var="x" value="#{rankingController.value.source}" tableStyleClass="app-table-auto">
									<p:column>#{x.region.name}</p:column>
									<p:column>#{of:formatNumberDefault(x[rankingController.property.name()])}</p:column>
								</p:dataTable>
							</div>
						</p:panel>
						<p:panel header="#{bundle[rankingController.property.name() += 'Delta']}">
							<div>
								<p:dataTable var="x" value="#{rankingController.delta.target}" tableStyleClass="app-table-auto">
									<p:column>#{x.region.name}</p:column>
									<p:column>#{of:formatNumberDefault(x[rankingController.property.name() += 'Delta'])}</p:column>
								</p:dataTable>
								<p:dataTable var="x" value="#{rankingController.delta.source}" tableStyleClass="app-table-auto">
									<p:column>#{x.region.name}</p:column>
									<p:column>#{of:formatNumberDefault(x[rankingController.property.name() += 'Delta'])}</p:column>
								</p:dataTable>
							</div>
						</p:panel>
						<p:panel header="#{bundle[rankingController.property.name() += 'DeltaPercent']}">
							<div>
								<p:dataTable var="x" value="#{rankingController.percent.target}" tableStyleClass="app-table-auto">
									<p:column>#{x.region.name}</p:column>
									<p:column>#{of:formatNumber(x[rankingController.property.name() += 'DeltaPercent'], '+0.00%;-0.00%')}</p:column>
								</p:dataTable>
								<p:dataTable var="x" value="#{rankingController.percent.source}" tableStyleClass="app-table-auto">
									<p:column>#{x.region.name}</p:column>
									<p:column>#{of:formatNumber(x[rankingController.property.name() += 'DeltaPercent'], '+0.00%;-0.00%')}</p:column>
								</p:dataTable>
							</div>
						</p:panel>
						<p:panel header="#{bundle[rankingController.property.name() += 'PopulationPercent']}">
							<div>
								<p:dataTable var="x" value="#{rankingController.population.target}" tableStyleClass="app-table-auto">
									<p:column>#{x.region.name}</p:column>
									<p:column>#{of:formatNumber(x[rankingController.property.name() += 'PopulationPercent'], '0.000%')}</p:column>
								</p:dataTable>
								<p:dataTable var="x" value="#{rankingController.population.source}" tableStyleClass="app-table-auto">
									<p:column>#{x.region.name}</p:column>
									<p:column>#{of:formatNumber(x[rankingController.property.name() += 'PopulationPercent'], '0.000%')}</p:column>
								</p:dataTable>
							</div>
						</p:panel>
						<p:panel header="#{bundle[rankingController.property.name() += 'Hypothetical']}">
							<div>
								<p:dataTable var="x" value="#{rankingController.hypothetical.target}" tableStyleClass="app-table-auto">
									<p:column>#{x.region.name}</p:column>
									<p:column>#{of:formatNumberDefault(x[rankingController.property.name() += 'Hypothetical'])}</p:column>
								</p:dataTable>
								<p:dataTable var="x" value="#{rankingController.hypothetical.source}" tableStyleClass="app-table-auto">
									<p:column>#{x.region.name}</p:column>
									<p:column>#{of:formatNumberDefault(x[rankingController.property.name() += 'Hypothetical'])}</p:column>
								</p:dataTable>
							</div>
						</p:panel>
					</div>
				</h:form>
			</p:tab>

			<p:tab id="tabTree" title="#{bundle.tree}">
				<h:form id="form">
					<ui:param name="region" value="#{bean.selectedNode.data}" />
					<ui:param name="record" value="#{region.latestRecord}" />

					<p:layout fullPage="false" stateful="false" style="height:100%; padding:5px;">
						<p:layoutUnit position="center">
							<p:tree id="tree" widgetVar="tree" var="data" value="#{bean.rootNode}" selectionMode="single" animate="true"
								highlight="true" styleClass="app-no-border">
								<p:ajax event="select" listener="#{bean.onSelect}" process="@this" update="@form:detail" />

								<p:treeNode>
									<h:outputLabel value="[#{of:formatDate(data.latestRecord.registered, 'yyyy-MM-dd')}] #{data.name}" />
								</p:treeNode>
							</p:tree>
						</p:layoutUnit>

						<p:layoutUnit position="east" size="75%" minSize="150">
							<p:outputPanel id="detail">
								<div class="section">
									<div>
										<div>#{bundle.region}</div>
										<div>#{region.name}</div>
									</div>
									<div>
										<div>#{bundle.population}</div>
										<div>#{of:formatNumberDefault(region.population)}</div>
									</div>
									<div>
										<div>#{bundle.latitude}</div>
										<div>#{region.latitude}</div>
									</div>
									<div>
										<div>#{bundle.longitude}</div>
										<div>#{region.longitude}</div>
									</div>

									<div>
										<div>#{bundle.lastUpdate}</div>
										<div>#{record.registered}</div>
									</div>

									<div>
										<div>#{bundle.aggregate}</div>
										<div>#{record.aggregate}</div>
									</div>
								</div>

								<br />

								<div class="section">
									<div>
										<div>#{bundle.lethality}</div>
										<div>#{of:formatNumber(record.lethality, '0.00%')}</div>
										<div>#{of:formatNumber(record.lethalityDelta, '+0.00%;-0.00%')}</div>
										<div>#{of:formatNumber(record.lethalityLatest, '0.00%')}</div>
									</div>
									<div>
										<div>#{bundle.growth}</div>
										<div>#{of:formatNumberDefault(record.growth)}</div>
									</div>

									<div>
										<div>#{bundle.testDensity}</div>
										<div>#{of:formatNumber(record.testDensity, '0.00%')}</div>
										<div>#{of:formatNumber(record.testDensityDelta, '+0.00%;-0.00%')}</div>
									</div>

									<div>
										<div>#{bundle.confirmedHypoteticalFull}</div>
										<div>#{of:formatNumber(confirmedHypoteticalFull, '0')} #{bundle.days}</div>
									</div>

									<div>
										<div>#{bundle.activeHypoteticalZero}</div>
										<div>#{of:formatNumber(record.activeHypoteticalZero, '0')} #{bundle.days}</div>
									</div>
								</div>

								<br />
								<br />

								<p:selectOneRadio id="property" value="#{bean.property}" layout="custom">
									<p:ajax listener="#{bean.buildCharts}" process="@this" update="chartPanel" />
									<f:selectItems var="property" value="#{RecordProperty.values()}" itemValue="#{property.name()}" />
								</p:selectOneRadio>

								<table width="100%">
									<tr>
										<c:forEach var="p" items="#{RecordProperty.values()}">
											<th style="white-space: nowrap; text-align: right">
												<p:radioButton for="property" itemIndex="#{p.ordinal()}" />
												<p:outputLabel for="@previous" value="#{bundle[p]}" />
											</th>
										</c:forEach>
									</tr>

									<tr>
										<c:forEach var="p" items="#{RecordProperty.values()}">
											<td style="text-align: right">#{of:formatNumberDefault(record[p.name()])}</td>
										</c:forEach>
									</tr>

									<tr>
										<c:forEach var="p" items="#{RecordProperty.values()}">
											<td style="text-align: right">#{of:formatNumber(record[p.name() += 'Delta'], '+#,##0;-#,##0')}</td>
										</c:forEach>
									</tr>

									<tr>
										<c:forEach var="p" items="#{RecordProperty.values()}">
											<td style="text-align: right">#{of:formatNumber(record[p.name() += 'DeltaPercent'],
												'+#,##0.00%;-#,##0.00%')}</td>
										</c:forEach>
									</tr>

									<tr>
										<td style="text-align: right">#{of:formatNumberDefault(record.confirmedHypothetical)}</td>
										<td style="text-align: right">#{of:formatNumberDefault(record.deceasedHypothetical)}</td>
										<td style="text-align: right">#{of:formatNumberDefault(record.recoveredHypothetical)}</td>
										<td style="text-align: right"></td>
										<td style="text-align: right"></td>
										<td style="text-align: right"></td>
										<td style="text-align: right"></td>
										<td style="text-align: right">#{of:formatNumberDefault(record.activeHypothetical)}</td>
										<td style="text-align: right">#{of:formatNumberDefault(record.closedHypothetical)}</td>
										<td style="text-align: right"></td>
									</tr>
								</table>

								<!-- <br/>
						
						<p:dataTable var="record" value="#{region.records}" rows="10" paginator="true" paginatorPosition="bottom">
							<p:column headerText="#{bundle.registered}">
								#{record.registered}
							</p:column>
							<p:column headerText="#{bundle.confirmed}">
								#{record.confirmed}
							</p:column>
							<p:column headerText="#{bundle.deceased}">
								#{record.deceased}
							</p:column>
							<p:column headerText="#{bundle.recovered}">
								#{record.recovered}
							</p:column>
						</p:dataTable> -->

								<br />
								<br />

								<p:outputPanel id="chartPanel">
									<div style="display: flex; justify-content: space-evenly;">
										<label>#{bundle.interval}</label>

										<div>
											<p:commandButton action="#{bean.lastWeek}" process="chartPanel" update="chartPanel"
												value="#{bundle.lastWeek}" />
											<p:commandButton action="#{bean.lastMonth}" process="chartPanel" update="chartPanel"
												value="#{bundle.lastMonth}" />
											<p:commandButton action="#{bean.fullInterval}" process="chartPanel" update="chartPanel"
												value="#{bundle.fullInterval}" />
										</div>

										<p:calendar value="#{bean.startDate}" mindate="#{bean.minDate}" maxdate="#{bean.maxDate}" pattern="yyyy-MM-dd"
											size="8">
											<p:ajax event="dateSelect" listener="#{bean.buildCharts}" process="chartPanel" update="chartPanel" />
										</p:calendar>

										<p:calendar value="#{bean.endDate}" mindate="#{bean.minDate}" maxdate="#{bean.maxDate}" pattern="yyyy-MM-dd"
											size="8">
											<p:ajax event="dateSelect" listener="#{bean.buildCharts}" process="chartPanel" update="chartPanel" />
										</p:calendar>

										<p:commandButton action="#{bean.buildCharts}" value="#{bundle.comparisonNode}" process="chartPanel"
											update="chartPanel">
											<f:setPropertyActionListener target="#{bean.comparisonNode}" value="#{bean.selectedNode}" />
										</p:commandButton>
									</div>

									<br />

									<p:tabView dynamic="true">
										<p:tab title="#{bundle[bean.property]}">
											<p:chart rendered="#{bean.valueChart != null}" type="line" model="#{bean.valueChart}" responsive="true" />
										</p:tab>
										<p:tab title="#{bundle[bean.property += 'Delta']}">
											<p:chart rendered="#{bean.deltaChart != null}" type="line" model="#{bean.deltaChart}" responsive="true" />
										</p:tab>
										<p:tab title="#{bundle[bean.property += 'DeltaPercent']}">
											<p:chart rendered="#{bean.percentChart != null}" type="line" model="#{bean.percentChart}" responsive="true" />
										</p:tab>
									</p:tabView>
								</p:outputPanel>
							</p:outputPanel>
						</p:layoutUnit>
					</p:layout>
				</h:form>

				<!-- <h:outputScript name="jqplot.canvasOverlay.min.js" target="head" />
		<h:outputScript target="head">
			function chartExtender()
			{
				this.cfg.axes = {
                    xaxis: {
                        renderer: $.jqplot.DateAxisRenderer,
                        rendererOptions: {
                            tickRenderer: $.jqplot.CanvasAxisTickRenderer
                        },
                        tickOptions: {
                            fontSize: '10pt',
                            angle: -60,
                            formatString: '%m-%d'
                        },
                        title: 'Datum'
                    }
                };
			
				this.cfg.canvasOverlay = {
		            show: true,
		            objects: [
	            	{
		            	verticalLine: {
				            shadow: false,
				            lineWidth: 2,
				            color: "rgb(255,0,0)",
				            x: 16.5 
						}
					}, 
					{
						verticalLine: {
				            shadow: false,
				            lineWidth: 2,
				            color: "rgb(0,255,0)",
				            x: 31.5 
						}
					}]
				};
			};
		</h:outputScript> -->
			</p:tab>

			<p:tab title="#{bundle.table}">
			</p:tab>
		</p:tabView>

	</h:body>
</f:view>
</html>
